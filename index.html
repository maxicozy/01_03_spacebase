<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
	<title>SPACE INVADERS</title>
	<link href="style.css" rel="stylesheet"/>
	<link href="https://fonts.googleapis.com/css?family=Press+Start+2P&display=swap" rel="stylesheet">
</head>
<body>
	<p class="scoreboard" id="scoreboard">Scoreboard</p>
  <pre id="console">
  	<!-- Hier landet später der Output aus Javascript -->
  </pre>

	<script src="classes.js"></script>
  <script>
		
		let startPosX = 1;
		let startPosY = 1;
		let invaders = [];
		const gameSpeed = 10;
		const invaderWidth = 8;
		const invaderHeight = 5;
    let renderStr = "";
    let rows = 50;
    let cols = 140;
    let cnt = 0;
    let spaceshipPos = Math.round(cols / 2);
    let currentSpaceshipBullets = [];
    let obstacles = [];
		let run = 0;
		let invaderDirection = 1;
		let invaderRow = [];
		let rowId = 0;
		let killedInvaderCount = 0;

	/*
	 *	SPIELELOGIK
	 */
	
	function newGame() {


	if (rowId == 0) {
		let newInvaderRow = new InvaderRow(startPosX, startPosY, invaderWidth, invaderHeight, InvaderRow.generateInvaderRow(invaderWidth, invaderHeight), rowId);
		invaders.push(newInvaderRow);
	}

		//TODO Punktestände
		obstacles.push({x: Math.round(cols/2)-5, 
						y: rows-10, 
						width: 10,
						height:3,
						char: "=" });
	}

	/*
	 *	HELFERFUNKTIONEN
	 */
	//Characters in String editieren

	//X/Y-Wert in fortlaufende String-Position umwandeln
	function xyToStringPos(posX, posY) {
		//Zusätzliche Characters wegen Zeilenumbrüchen
		let rowOffset = posY; 
		//Position im Gesamtstring, (AnzahlZeilen/YPos+i)*ZeichenProZeile plus rowOffset plus momentan gezeichnete Zeile des Ships
		let posInString = posY*cols+rowOffset+posX; 
		return posInString;
	}

	//Spieler-Interaktionen verschicken
	document.addEventListener('keydown', (event) => {
	  const keyCode = event.keyCode;	  

			if(keyCode === 37) {
				//Linke Pfeiltaste - Spaceship nach links bewegen
	  	spaceshipPos = Math.max(0, spaceshipPos-1);
	  } else if(keyCode === 39) {
	  	//Rechte Pfeiltaste - Spaceship nach rechts bewegen
	  	spaceshipPos = Math.min(cols-7, spaceshipPos+1);
	  } else if(keyCode === 32) {
	  	//Leertase - Feuer!
	  	fireSpaceshipBullet();
	  }
	}, false);

	/*
	 * RENDERFUNKTIONEN
	 */
	
	function renderBackground(rows, cols) {
		//console.log("render "+cnt)
		let str = ""
		for (var i = 0; i < rows; i++) {
			for (var j = 0; j < cols; j++) {
				if(i == cnt + (Math.round(Math.random()*30)) * 2) str += "*"
				else str += " "
			}
			str += "\n";
		}
		cnt++;
		if(cnt * 5 > rows * 0.2) cnt = 0;
		return str;
	}

	function renderSpaceship(posX, posY) {
		//Spaceship-Array
		let spaceship = ["   !  ",
						 				 " ~ ° ~",
						 				 "/:::::\\",
						 				 "|:::::|"]

		for (var i = 0; i < spaceship.length; i++) {			
			//Zeilenweise in String schreiben
			renderStr = Helper.setCharsAt(renderStr,xyToStringPos(posX, posY+i),spaceship[i]);
		}
	}

	function renderObstacles() {
		obstacles.forEach((obstacle) => {
			for (var i = 0; i < obstacle.height; i++) {			
				//Zeilenweise in String schreiben
				renderStr = Helper.setCharsAt(renderStr,xyToStringPos(obstacle.x, obstacle.y+i),obstacle.char.repeat(obstacle.width));
			}
		});
	}

	function renderBullets() {
		//Kugeln entfernen die am oberen Rand angekommen sind ohne Treffer
		currentSpaceshipBullets = currentSpaceshipBullets.filter(bullet => bullet.y > 1);
		//Kugeln einen Schritt weiter bewegen, dann rendern
		currentSpaceshipBullets.forEach((bullet) => {
			bullet.y -= 1;
			if (renderStr[xyToStringPos(bullet.x, bullet.y - 1)] == '#') {
				let currentId = 0;
				for (let invaderPos = invaders[rowId].posX; invaderPos <= invaders[rowId].posX + 5*(invaderWidth*2+invaderWidth/2); invaderPos = invaderPos + invaderWidth*2+invaderWidth/2) {
					if (bullet.x > invaderPos && bullet.x < invaderPos + invaderWidth*2 + invaderWidth) {
						invaders[rowId].invaders[currentId].ischBinKaputt = true;
						invaders[rowId].invaders[currentId].explode();
						killedInvaderCount++;
						break;
					}
					currentId++;
				}
				currentSpaceshipBullets = currentSpaceshipBullets.filter(currentBullet => currentBullet != bullet);
			}
			if (renderStr[xyToStringPos(bullet.x, bullet.y - 1)] == '=') {
				currentSpaceshipBullets = currentSpaceshipBullets.filter(currentBullet => currentBullet != bullet);
			}	
			renderStr = Helper.setCharsAt(renderStr,xyToStringPos(bullet.x, bullet.y),"|"); 
		})			
	}
	
	function fireSpaceshipBullet() {
		currentSpaceshipBullets.push({x: spaceshipPos+3, y: rows-4});
	}

	function renderInvaderRow(invaders) {
		let currentInvXPos = invaders[rowId].posX;
		for (let j = 0; j < invaders[rowId].invaders.length; j++) {
			for (let i = 0; i < invaders[rowId].invaders[j].appearance.length; i++) {
				renderStr = Helper.setCharsAt(renderStr,xyToStringPos(invaders[rowId].invaders[j].id + currentInvXPos, invaders[rowId].posY+i), invaders[rowId].invaders[j].appearance[i]);		
			}
			currentInvXPos = currentInvXPos + invaderWidth* 2 + invaderWidth/2;
		}
	}

	//Hauptrenderfunktion
	function render() {
		run++
		if (run >= gameSpeed) {
			run = 0;
			for (let i = rowId; i < invaders.length; i++) {
				for (let j = 0; j < invaders[i].invaders.length; j++) {
					if (invaders[i].invaders[j].ischBinKaputt) {
						invaders[i].invaders[j].explodeTime++;
					}
					if (invaders[i].invaders[j].explodeTime >= 2) {
						invaders[i].invaders[j].appearance = [];
					}
				}	
			}
					if (invaders[rowId].posX == 0 ||invaders[rowId].posX  ==  Math.floor(cols*0.2 + invaderWidth*2 - 5)) {
						invaders[rowId].step("down");
						invaderDirection = invaderDirection * (-1);
						invaders[rowId].step(invaderDirection);
					}
				else {
					invaders[rowId].step(invaderDirection);
				}
		}
		//Render Background
		renderStr = renderBackground(rows,cols);
		//Render Obstacle
		renderObstacles();
		renderSpaceship(spaceshipPos, rows-4, renderStr);
		//Render Invaders
		renderInvaderRow(invaders, renderStr);
		//Gesamtergebnis anzeigen
		//Render Bullets
		renderBullets(renderStr);
		document.getElementById("scoreboard").innerText = "Scoreboard \n \n" + killedInvaderCount;
		document.getElementById("console").innerText = renderStr;
	}

	//Es geht los - alle 40 Millisekunden rendern		
	newGame();
	setInterval(render, 40);
  </script>
</body>
</html>